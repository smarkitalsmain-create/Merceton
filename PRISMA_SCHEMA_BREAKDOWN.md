# Prisma Schema Breakdown

Complete analysis of `prisma/schema.prisma` - all models, relationships, constraints, enums, and tenancy boundaries.

## Enums

### `MerchantAccountStatus`
- `ACTIVE` - Merchant account is active
- `ON_HOLD` - Account is on hold
- `SUSPENDED` - Account is suspended

### `UserRole`
- `ADMIN` - Admin user role
- `STAFF` - Staff user role

### `DomainStatus`
- `PENDING` - Domain verification pending
- `VERIFIED` - Domain verified
- `ACTIVE` - Domain active

### `StorefrontMode`
- `THEME` - Theme-based storefront
- `BUILDER` - Builder-based storefront
- `CUSTOM_CODE` - Custom code storefront

### `OrderStatus`
- `PENDING` - Order pending
- `PLACED` - Order placed
- `CONFIRMED` - Order confirmed
- `PROCESSING` - Order processing
- `SHIPPED` - Order shipped
- `DELIVERED` - Order delivered
- `CANCELLED` - Order cancelled

### `OrderStage`
- `NEW` - New order
- `CONFIRMED` - Order confirmed
- `PACKED` - Order packed
- `SHIPPED` - Order shipped
- `OUT_FOR_DELIVERY` - Out for delivery
- `DELIVERED` - Order delivered
- `CANCELLED` - Order cancelled
- `RETURNED` - Order returned

### `InvoiceType`
- `TAX_INVOICE` - Tax invoice
- `BILL_OF_SUPPLY` - Bill of supply

### `RefundStatus`
- `PENDING` - Refund pending
- `COMPLETED` - Refund completed
- `FAILED` - Refund failed

### `OrderEventType`
- `STAGE_CHANGE` - Stage change event
- `PAYMENT_UPDATE` - Payment update event
- `NOTE` - Note event
- `SYSTEM` - System event

### `PaymentMethod`
- `RAZORPAY` - Razorpay payment
- `COD` - Cash on delivery
- `UPI` - UPI payment

### `PaymentStatus`
- `CREATED` - Payment created
- `PENDING` - Payment pending
- `PAID` - Payment paid
- `FAILED` - Payment failed
- `REFUNDED` - Payment refunded
- `PARTIALLY_REFUNDED` - Payment partially refunded

### `SettlementStatus`
- `NOT_ELIGIBLE` - Not eligible for settlement
- `ELIGIBLE` - Eligible for settlement
- `ON_HOLD` - Settlement on hold
- `SETTLED` - Settlement settled

### `LedgerType`
- `GROSS_ORDER_VALUE` - Gross order value
- `PLATFORM_FEE` - Platform fee
- `ORDER_PAYOUT` - Order payout
- `PAYOUT_PROCESSED` - Payout processed

### `LedgerStatus`
- `PENDING` - Ledger entry pending
- `PROCESSING` - Ledger entry processing
- `COMPLETED` - Ledger entry completed
- `FAILED` - Ledger entry failed

### `TaxType`
- `CGST_SGST` - CGST + SGST (intra-state)
- `IGST` - IGST (inter-state)

### `PayoutStatus`
- `PENDING` - Payout pending
- `PROCESSING` - Payout processing
- `COMPLETED` - Payout completed
- `FAILED` - Payout failed

### `PricingPackageStatus`
- `DRAFT` - Package draft
- `PUBLISHED` - Package published
- `ARCHIVED` - Package archived

### `PayoutFrequency`
- `WEEKLY` - Weekly payout
- `DAILY` - Daily payout
- `MANUAL` - Manual payout

### `PackageVisibility`
- `PUBLIC` - Public package
- `INTERNAL` - Internal package

### `OnboardingStatus`
- `NOT_STARTED` - Onboarding not started
- `IN_PROGRESS` - Onboarding in progress
- `COMPLETED` - Onboarding completed

### `GstStatus`
- `REGISTERED` - GST registered
- `APPLIED` - GST application submitted
- `NOT_REGISTERED` - GST not registered

### `BankAccountType`
- `SAVINGS` - Savings account
- `CURRENT` - Current account

### `BankVerificationStatus`
- `NOT_SUBMITTED` - Not submitted
- `PENDING` - Pending verification
- `VERIFIED` - Verified
- `REJECTED` - Rejected

### `BankProofType`
- `CANCELLED_CHEQUE` - Cancelled cheque
- `BANK_STATEMENT` - Bank statement

### `PlatformSettlementStatus`
- `DRAFT` - Settlement draft
- `INVOICED` - Settlement invoiced
- `PAID` - Settlement paid

### `PlatformInvoiceStatus`
- `ISSUED` - Invoice issued
- `CANCELLED` - Invoice cancelled
- `PAID` - Invoice paid

### `PlatformInvoiceLineItemType`
- `PLATFORM_FEE` - Platform fee
- `SHIPPING` - Shipping
- `ADJUSTMENT` - Adjustment
- `PENALTY` - Penalty
- `OTHER` - Other

### `AuditAction`
- `PRICING_PACKAGE_CREATE` - Pricing package created
- `PRICING_PACKAGE_UPDATE` - Pricing package updated
- `PRICING_PACKAGE_PUBLISH` - Pricing package published
- `PRICING_PACKAGE_ARCHIVE` - Pricing package archived
- `PRICING_PACKAGE_TOGGLE_ACTIVE` - Pricing package active toggled
- `PRICING_PACKAGE_DELETE` - Pricing package deleted
- `MERCHANT_PACKAGE_ASSIGN` - Merchant package assigned
- `MERCHANT_PACKAGE_UPDATE_OVERRIDES` - Merchant package overrides updated
- `MERCHANT_DOMAIN_SUBSCRIPTION_TOGGLE` - Merchant domain subscription toggled
- `MERCHANT_ACTIVATE` - Merchant activated
- `MERCHANT_DEACTIVATE` - Merchant deactivated
- `MERCHANT_HOLDBACK_SET` - Merchant holdback set
- `MERCHANT_PAYOUT_HOLD_SET` - Merchant payout hold set
- `PLATFORM_SETTINGS_UPDATE` - Platform settings updated

### `InvoiceGeneratedBy`
- `MERCHANT` - Generated by merchant
- `ADMIN` - Generated by admin
- `SYSTEM` - Generated by system

---

## Models

### 1. `Merchant`
**Tenancy Boundary**: Root tenant entity (no `merchantId` field)

**Key Fields**:
- `id` (String, @id, cuid)
- `slug` (String, @unique) - Store URL slug
- `displayName` (String) - Display name
- `isActive` (Boolean, default: true)
- `accountStatus` (MerchantAccountStatus, default: ACTIVE)
- `holdReason`, `holdAt`, `holdBy` (String?, DateTime?, String?) - Account hold fields
- `customDomain`, `domainStatus`, `domainVerificationToken`, `domainVerifiedAt` - Domain config
- `feePercentageBps`, `feeFlatPaise`, `feeMaxCapPaise` (Int?) - Legacy fee config
- `createdAt`, `updatedAt` (DateTime)

**Relationships**:
- `users` → `User[]` (one-to-many)
- `storefront` → `StorefrontSettings?` (one-to-one)
- `pages` → `StorefrontPage[]` (one-to-many)
- `products` → `Product[]` (one-to-many)
- `orders` → `Order[]` (one-to-many)
- `payments` → `Payment[]` (one-to-many)
- `ledgerEntries` → `LedgerEntry[]` (one-to-many)
- `payoutBatches` → `PayoutBatch[]` (one-to-many)
- `feeConfig` → `MerchantFeeConfig?` (one-to-one)
- `bankAccount` → `MerchantBankAccount?` (one-to-one)
- `onboarding` → `MerchantOnboarding?` (one-to-one)
- `storeSettings` → `MerchantStoreSettings?` (one-to-one)
- `platformInvoices` → `PlatformInvoice[]` (one-to-many)
- `InvoiceRecord` → `InvoiceRecord[]` (one-to-many)

**Unique Constraints**:
- `slug` (@unique)

**Indexes**:
- `slug`
- `isActive`
- `customDomain`
- `[customDomain, domainStatus]`

---

### 2. `User`
**Tenancy Boundary**: `merchantId` (String?, nullable)

**Key Fields**:
- `id` (String, @id, cuid)
- `merchantId` (String?, nullable) - Links to Merchant
- `authUserId` (String, @unique) - Supabase auth user ID
- `email` (String)
- `name` (String?)
- `role` (UserRole, default: ADMIN)
- `isActive` (Boolean, default: true)
- `createdAt`, `updatedAt` (DateTime)

**Relationships**:
- `merchant` → `Merchant?` (many-to-one, nullable, onDelete: SetNull)

**Unique Constraints**:
- `authUserId` (@unique)

**Indexes**:
- `merchantId`
- `authUserId`

---

### 3. `StorefrontSettings`
**Tenancy Boundary**: `merchantId` (String, @unique)

**Key Fields**:
- `id` (String, @id, cuid)
- `merchantId` (String, @unique)
- `mode` (StorefrontMode, default: THEME)
- `theme` (String?, default: "minimal")
- `themeConfig` (Json?)
- `customHtml`, `customCss`, `customJs` (String?, @db.Text)
- `builderJson` (Json?)
- `builderHtml`, `builderCss` (String?, @db.Text)
- `logoUrl` (String?)
- `publishedAt` (DateTime?)
- `createdAt`, `updatedAt` (DateTime)

**Relationships**:
- `merchant` → `Merchant` (many-to-one, onDelete: Cascade)

**Unique Constraints**:
- `merchantId` (@unique)

---

### 4. `StorefrontPage`
**Tenancy Boundary**: `merchantId` (String)

**Key Fields**:
- `id` (String, @id, cuid)
- `merchantId` (String)
- `slug` (String, default: "home")
- `title` (String)
- `layoutJson` (Json) - Section-based layout
- `isPublished` (Boolean, default: true)
- `publishedAt` (DateTime?)
- `createdAt`, `updatedAt` (DateTime)

**Relationships**:
- `merchant` → `Merchant` (many-to-one, onDelete: Cascade)

**Unique Constraints**:
- `[merchantId, slug]` (@unique)

**Indexes**:
- `merchantId`

---

### 5. `Product`
**Tenancy Boundary**: `merchantId` (String)

**Key Fields**:
- `id` (String, @id, cuid)
- `merchantId` (String)
- `name` (String)
- `description` (String?)
- `price` (Int) - Price in paise
- `mrp` (Int?) - MRP in paise
- `sku` (String?)
- `stock` (Int, default: 0)
- `isActive` (Boolean, default: true)
- `hsnOrSac` (String?) - HSN/SAC code
- `gstRate` (Int?) - GST rate percentage
- `isTaxable` (Boolean, default: true)
- `createdAt`, `updatedAt` (DateTime)

**Relationships**:
- `merchant` → `Merchant` (many-to-one, onDelete: Cascade)
- `images` → `ProductImage[]` (one-to-many)
- `orderItems` → `OrderItem[]` (one-to-many)

**Indexes**:
- `merchantId`
- `[merchantId, isActive]`
- `[merchantId, createdAt]`
- `sku`

---

### 6. `ProductImage`
**Tenancy Boundary**: Via `productId` → `Product.merchantId`

**Key Fields**:
- `id` (String, @id, cuid)
- `productId` (String)
- `url` (String)
- `alt` (String?)
- `sortOrder` (Int, default: 0)
- `createdAt` (DateTime)

**Relationships**:
- `product` → `Product` (many-to-one, onDelete: Cascade)

**Indexes**:
- `productId`
- `[productId, sortOrder]`

---

### 7. `Order`
**Tenancy Boundary**: `merchantId` (String)

**Key Fields**:
- `id` (String, @id, cuid)
- `merchantId` (String)
- `orderNumber` (String?) - Temporarily optional (duplicate fix in progress)
- `customerName`, `customerEmail`, `customerPhone`, `customerAddress` (String)
- `shippingAddress` (Json?)
- `stage` (OrderStage, default: NEW)
- `status` (OrderStatus, default: PENDING)
- `paymentStatus` (PaymentStatus, default: PENDING)
- `settlementStatus` (SettlementStatus, default: NOT_ELIGIBLE)
- `subtotal`, `tax`, `shippingFee`, `discount`, `totalAmount` (Decimal, @db.Decimal(10, 2))
- `grossAmount`, `platformFee`, `netPayable` (Decimal, @db.Decimal(10, 2)) - Legacy fields
- `invoiceNumber`, `invoiceIssuedAt`, `invoiceType` (String?, DateTime?, InvoiceType?)
- `createdAt`, `updatedAt` (DateTime)

**Relationships**:
- `merchant` → `Merchant` (many-to-one, onDelete: Cascade)
- `items` → `OrderItem[]` (one-to-many)
- `payment` → `Payment?` (one-to-one)
- `ledgerEntries` → `LedgerEntry[]` (one-to-many)
- `shipments` → `Shipment[]` (one-to-many)
- `refunds` → `Refund[]` (one-to-many)
- `events` → `OrderEvent[]` (one-to-many)
- `platformInvoiceLinks` → `PlatformInvoiceOrder[]` (one-to-many)

**Indexes**:
- `merchantId`
- `[merchantId, status]`
- `[merchantId, stage]`
- `[merchantId, createdAt]`
- `orderNumber`

---

### 8. `OrderItem`
**Tenancy Boundary**: Via `orderId` → `Order.merchantId`

**Key Fields**:
- `id` (String, @id, cuid)
- `orderId` (String)
- `productId` (String)
- `productName`, `sku`, `imageUrl` (String?)
- `quantity` (Int)
- `price` (Int) - Price in paise
- `createdAt` (DateTime)

**Relationships**:
- `order` → `Order` (many-to-one, onDelete: Cascade)
- `product` → `Product` (many-to-one)

**Indexes**:
- `orderId`
- `productId`

---

### 9. `Shipment`
**Tenancy Boundary**: Via `orderId` → `Order.merchantId`

**Key Fields**:
- `id` (String, @id, cuid)
- `orderId` (String)
- `courierName` (String)
- `awb` (String) - Airway bill number
- `trackingUrl` (String?)
- `shippedAt`, `deliveredAt` (DateTime?)
- `createdAt`, `updatedAt` (DateTime)

**Relationships**:
- `order` → `Order` (many-to-one, onDelete: Cascade)

**Indexes**:
- `orderId`

---

### 10. `Refund`
**Tenancy Boundary**: Via `orderId` → `Order.merchantId`

**Key Fields**:
- `id` (String, @id, cuid)
- `orderId` (String)
- `amount` (Decimal, @db.Decimal(10, 2))
- `reason` (String)
- `status` (RefundStatus, default: PENDING)
- `createdAt`, `updatedAt` (DateTime)

**Relationships**:
- `order` → `Order` (many-to-one, onDelete: Cascade)

**Indexes**:
- `orderId`

---

### 11. `OrderEvent`
**Tenancy Boundary**: Via `orderId` → `Order.merchantId`

**Key Fields**:
- `id` (String, @id, cuid)
- `orderId` (String)
- `type` (OrderEventType)
- `message` (String)
- `oldValue`, `newValue` (Json?)
- `createdBy` (String)
- `createdAt` (DateTime)

**Relationships**:
- `order` → `Order` (many-to-one, onDelete: Cascade)

**Indexes**:
- `orderId`
- `createdAt`

---

### 12. `Payment`
**Tenancy Boundary**: `merchantId` (String)

**Key Fields**:
- `id` (String, @id, cuid)
- `merchantId` (String)
- `orderId` (String, @unique)
- `paymentMethod` (PaymentMethod)
- `status` (PaymentStatus, default: PENDING)
- `razorpayOrderId`, `razorpayPaymentId`, `razorpaySignature` (String?)
- `upiTransactionId` (String?)
- `codCollected`, `codCollectedAt` (Boolean, DateTime?)
- `amount` (Decimal, @db.Decimal(10, 2))
- `createdAt`, `updatedAt` (DateTime)

**Relationships**:
- `merchant` → `Merchant` (many-to-one, onDelete: Cascade)
- `order` → `Order` (one-to-one, onDelete: Cascade)

**Unique Constraints**:
- `orderId` (@unique)

**Indexes**:
- `merchantId`
- `[merchantId, status]`
- `orderId`
- `razorpayOrderId`
- `razorpayPaymentId`
- `[merchantId, createdAt]`

---

### 13. `LedgerEntry`
**Tenancy Boundary**: `merchantId` (String)

**Key Fields**:
- `id` (String, @id, cuid)
- `merchantId` (String)
- `orderId` (String?)
- `type` (LedgerType)
- `amount` (Decimal, @db.Decimal(10, 2))
- `description` (String?)
- `status` (LedgerStatus, default: PENDING)
- `payoutBatchId`, `invoiceRecordId` (String?)
- `baseAmountPaise`, `gstAmountPaise`, `totalAmountPaise` (Int?) - GST fields in paise
- `taxType` (TaxType?)
- `cgstPaise`, `sgstPaise`, `igstPaise` (Int, default: 0)
- `currency` (String, default: "INR")
- `occurredAt` (DateTime, default: now()) - Transaction occurrence time
- `metadataJson` (Json?)
- `createdAt`, `updatedAt` (DateTime)

**Relationships**:
- `merchant` → `Merchant` (many-to-one, onDelete: Cascade)
- `order` → `Order?` (many-to-one, nullable, onDelete: Cascade)
- `payoutBatch` → `PayoutBatch?` (many-to-one, nullable, onDelete: SetNull)
- `invoiceRecord` → `InvoiceRecord?` (many-to-one, nullable, onDelete: SetNull)

**Indexes**:
- `merchantId`
- `[merchantId, type]`
- `[merchantId, status]`
- `orderId`
- `payoutBatchId`
- `[merchantId, createdAt]`
- `[merchantId, occurredAt]`
- `[merchantId, type, occurredAt]`

---

### 14. `PayoutBatch`
**Tenancy Boundary**: `merchantId` (String)

**Key Fields**:
- `id` (String, @id, cuid)
- `merchantId` (String)
- `totalAmount` (Decimal, @db.Decimal(10, 2))
- `status` (PayoutStatus, default: PENDING)
- `razorpayPayoutId` (String?)
- `processedAt` (DateTime?)
- `cycleId`, `platformInvoiceId` (String?) - Links to settlement cycle and platform invoice
- `createdAt`, `updatedAt` (DateTime)

**Relationships**:
- `merchant` → `Merchant` (many-to-one, onDelete: Cascade)
- `ledgerEntries` → `LedgerEntry[]` (one-to-many)
- `platformInvoice` → `PlatformInvoice?` (many-to-one, nullable, onDelete: SetNull)

**Indexes**:
- `merchantId`
- `[merchantId, status]`
- `[merchantId, createdAt]`
- `razorpayPayoutId`
- `cycleId`
- `platformInvoiceId`

---

### 15. `PricingPackage`
**Tenancy Boundary**: None (platform-wide)

**Key Fields**:
- `id` (String, @id, cuid)
- `name` (String)
- `description` (String?)
- `status` (PricingPackageStatus, default: DRAFT)
- `fixedFeePaise` (Int) - Fixed fee per order in paise
- `variableFeeBps` (Int) - Variable fee in basis points
- `domainPricePaise` (Int, default: 9900) - ₹99 default
- `domainAllowed` (Boolean, default: true)
- `domainIncluded` (Boolean, default: false)
- `payoutFrequency` (PayoutFrequency, default: WEEKLY)
- `holdbackBps` (Int, default: 0)
- `isPayoutHold` (Boolean, default: false)
- `isActive` (Boolean, default: true)
- `visibility` (PackageVisibility, default: PUBLIC)
- `deletedAt` (DateTime?) - Soft delete
- `createdAt`, `updatedAt` (DateTime)

**Relationships**:
- `merchantFeeConfigs` → `MerchantFeeConfig[]` (one-to-many)
- `auditLogs` → `AdminAuditLog[]` (one-to-many)
- `platformSettings` → `PlatformSettings[]` (one-to-many)

**Indexes**:
- `status`
- `isActive`
- `visibility`
- `deletedAt`

---

### 16. `MerchantFeeConfig`
**Tenancy Boundary**: `merchantId` (String, @unique)

**Key Fields**:
- `id` (String, @id, cuid)
- `merchantId` (String, @unique)
- `pricingPackageId` (String?)
- `fixedFeeOverridePaise`, `variableFeeOverrideBps` (Int?)
- `payoutFrequencyOverride` (PayoutFrequency?)
- `holdbackOverrideBps` (Int?)
- `isPayoutHoldOverride` (Boolean?)
- `domainSubscriptionActive` (Boolean, default: false)
- `domainIncludedApplied` (Boolean?)
- `createdAt`, `updatedAt` (DateTime)

**Relationships**:
- `merchant` → `Merchant` (one-to-one, onDelete: Cascade)
- `pricingPackage` → `PricingPackage?` (many-to-one, nullable, onDelete: SetNull)

**Unique Constraints**:
- `merchantId` (@unique)

**Indexes**:
- `merchantId`
- `pricingPackageId`

---

### 17. `AdminAuditLog`
**Tenancy Boundary**: None (platform-wide audit)

**Key Fields**:
- `id` (String, @id, cuid)
- `actorUserId` (String) - Supabase/Clerk user ID
- `actorEmail` (String?)
- `action` (String) - Action name
- `entityType` (String) - Entity type
- `entityId` (String?)
- `reason` (String?)
- `beforeJson`, `afterJson` (Json?) - Snapshots
- `ip`, `userAgent` (String?)
- `metadata` (Json?)
- `createdAt` (DateTime)
- `pricingPackageId` (String?)

**Relationships**:
- `pricingPackage` → `PricingPackage?` (many-to-one, nullable, onDelete: SetNull)

**Indexes**:
- `actorUserId`
- `action`
- `[entityType, entityId]`
- `createdAt`

---

### 18. `PlatformSettings`
**Tenancy Boundary**: None (singleton, platform-wide)

**Key Fields**:
- `id` (String, @id, default: "singleton")
- `defaultFeePercentageBps` (Int?, default: 200) - 2% legacy
- `defaultFeeFlatPaise` (Int?, default: 500) - ₹5 legacy
- `defaultFeeMaxCapPaise` (Int?, default: 2500) - ₹25 legacy
- `defaultPricingPackageId` (String?)
- `createdAt`, `updatedAt` (DateTime)

**Relationships**:
- `defaultPricingPackage` → `PricingPackage?` (many-to-one, nullable, onDelete: SetNull)

---

### 19. `MerchantOnboarding`
**Tenancy Boundary**: `merchantId` (String, @unique)

**Key Fields**:
- `id` (String, @id, cuid)
- `merchantId` (String, @unique)
- `onboardingStatus` (OnboardingStatus, default: NOT_STARTED)
- `completedAt` (DateTime?)
- `profileCompletionPercent` (Int?, default: 0)
- PAN fields: `panType`, `panNumber`, `panName`, `panDobOrIncorp`, `panHolderRole`, `panVerifiedAt`, `panVerifiedBy`
- GST fields: `gstStatus`, `gstin`, `gstLegalName`, `gstTradeName`, `gstState`, `gstComposition`, `gstNotRegisteredReason`, `gstVerifiedAt`, `gstVerifiedBy`
- Invoice address: `invoiceAddressLine1`, `invoiceAddressLine2`, `invoiceCity`, `invoicePincode`, `invoicePhone`, `invoiceEmail`, `invoicePrefix`
- Contact info: `contactEmail`, `contactPhone`, `websiteUrl`, `contactAddressLine1`, `contactAddressLine2`, `contactCity`, `contactState`, `contactPincode`
- Business basics: `storeDisplayName`, `legalBusinessName`, `yearStarted`, `businessType`, `primaryCategory`, `secondaryCategory`, `avgPriceRange`, `expectedSkuRange`
- `createdAt`, `updatedAt` (DateTime)

**Relationships**:
- `merchant` → `Merchant` (one-to-one, onDelete: Cascade)

**Unique Constraints**:
- `merchantId` (@unique)

**Indexes**:
- `merchantId`
- `onboardingStatus`

---

### 20. `MerchantBankAccount`
**Tenancy Boundary**: `merchantId` (String, @unique)

**Key Fields**:
- `id` (String, @id, cuid)
- `merchantId` (String, @unique)
- `accountHolderName` (String)
- `bankName` (String)
- `accountNumber` (String)
- `ifscCode` (String)
- `accountType` (BankAccountType, default: SAVINGS)
- `isPrimary` (Boolean, default: true)
- `verificationStatus` (BankVerificationStatus, default: NOT_SUBMITTED)
- `proofType` (BankProofType?)
- `proofDocumentUrl` (String?)
- `proofUploadedAt`, `submittedAt`, `verifiedAt`, `rejectedAt` (DateTime?)
- `verifiedBy`, `rejectionReason` (String?)
- `createdAt`, `updatedAt` (DateTime)

**Relationships**:
- `merchant` → `Merchant` (one-to-one, onDelete: Cascade)

**Unique Constraints**:
- `merchantId` (@unique)

**Indexes**:
- `merchantId`
- `verificationStatus`

---

### 21. `MerchantStoreSettings`
**Tenancy Boundary**: `merchantId` (String, @unique)

**Key Fields**:
- `id` (String, @id, cuid)
- `merchantId` (String, @unique)
- Store identity: `storeName`, `tagline`, `description`
- Branding: `logoUrl`, `bannerUrl`, `faviconUrl`, `brandPrimaryColor`, `brandSecondaryColor`
- Contact: `supportEmail`, `supportPhone`, `whatsappNumber`, `businessAddressLine1`, `businessAddressLine2`, `city`, `state`, `pincode`
- Policies: `returnPolicy`, `refundPolicy`, `shippingPolicy`, `termsAndConditions`, `privacyPolicy`
- Invoice settings: `invoicePrefix`, `invoiceNextNumber`, `invoiceNumberPadding`, `invoiceSeriesFormat`, `resetFy`
- Social & tracking: `instagramUrl`, `facebookUrl`, `youtubeUrl`, `linkedinUrl`, `twitterUrl`, `googleAnalyticsId`, `metaPixelId`
- Operational: `isStoreLive`, `showOutOfStockProducts`, `allowGuestCheckout`, `storeTimezone`
- SEO: `seoTitle`, `seoDescription`, `ogImageUrl`
- `createdAt`, `updatedAt` (DateTime)

**Relationships**:
- `merchant` → `Merchant` (one-to-one, onDelete: Cascade)

**Unique Constraints**:
- `merchantId` (@unique)

**Indexes**:
- `merchantId`

---

### 22. `PlatformBillingProfile`
**Tenancy Boundary**: None (singleton, platform-wide)

**Key Fields**:
- `id` (String, @id, default: "platform")
- `legalName` (String, default: "Smarkitals Technologies India Pvt Ltd")
- `gstin`, `addressLine1`, `addressLine2`, `city`, `state`, `pincode`, `email`, `phone` (String?)
- `invoicePrefix` (String, default: "SMK")
- `invoiceNextNumber` (Int, default: 1)
- `invoicePadding` (Int, default: 5)
- `seriesFormat` (String, default: "{PREFIX}-{FY}-{NNNNN}")
- `defaultSacCode` (String, default: "9983")
- `defaultGstRate` (Decimal, default: 18, @db.Decimal(5, 2))
- `footerNote` (String?)
- `updatedAt`, `createdAt` (DateTime)

---

### 23. `PlatformSettlementCycle`
**Tenancy Boundary**: None (platform-wide)

**Key Fields**:
- `id` (String, @id, cuid)
- `periodStart` (DateTime)
- `periodEnd` (DateTime) - Thursday 23:59:59
- `invoiceGeneratedAt`, `payoutScheduledFor`, `payoutExecutedAt` (DateTime?)
- `status` (PlatformSettlementStatus, default: DRAFT)
- `createdAt`, `updatedAt` (DateTime)

**Relationships**:
- `invoices` → `PlatformInvoice[]` (one-to-many)

**Unique Constraints**:
- `[periodStart, periodEnd]` (@unique)

**Indexes**:
- `status`
- `periodStart`
- `periodEnd`

---

### 24. `PlatformInvoice`
**Tenancy Boundary**: `merchantId` (String)

**Key Fields**:
- `id` (String, @id, cuid)
- `merchantId` (String)
- `cycleId` (String)
- `invoiceNumber` (String, @unique)
- `invoiceDate` (DateTime)
- `currency` (String, default: "INR")
- `subtotal` (Decimal, @db.Decimal(10, 2)) - Excluding GST
- `gstAmount` (Decimal, @db.Decimal(10, 2))
- `total` (Decimal, @db.Decimal(10, 2)) - subtotal + gst
- `status` (PlatformInvoiceStatus, default: ISSUED)
- `cancelledAt` (DateTime?)
- `createdAt`, `updatedAt` (DateTime)

**Relationships**:
- `merchant` → `Merchant` (many-to-one, onDelete: Cascade)
- `cycle` → `PlatformSettlementCycle` (many-to-one, onDelete: Cascade)
- `lineItems` → `PlatformInvoiceLineItem[]` (one-to-many)
- `payoutBatches` → `PayoutBatch[]` (one-to-many)
- `orders` → `PlatformInvoiceOrder[]` (one-to-many)

**Unique Constraints**:
- `invoiceNumber` (@unique)

**Indexes**:
- `merchantId`
- `cycleId`
- `invoiceNumber`
- `status`
- `invoiceDate`

---

### 25. `PlatformInvoiceLineItem`
**Tenancy Boundary**: Via `invoiceId` → `PlatformInvoice.merchantId`

**Key Fields**:
- `id` (String, @id, cuid)
- `invoiceId` (String)
- `type` (PlatformInvoiceLineItemType)
- `description` (String)
- `sacCode` (String?)
- `quantity` (Decimal, default: 1, @db.Decimal(10, 2))
- `unitPrice`, `amount`, `gstRate`, `gstAmount`, `totalAmount` (Decimal, @db.Decimal(10, 2))
- `createdAt` (DateTime)

**Relationships**:
- `invoice` → `PlatformInvoice` (many-to-one, onDelete: Cascade)

**Indexes**:
- `invoiceId`

---

### 26. `PlatformInvoiceOrder`
**Tenancy Boundary**: Via `orderId` → `Order.merchantId`

**Key Fields**:
- `id` (String, @id, cuid)
- `platformInvoiceId` (String)
- `orderId` (String)
- `createdAt` (DateTime)

**Relationships**:
- `platformInvoice` → `PlatformInvoice` (many-to-one, onDelete: Cascade)
- `order` → `Order` (many-to-one, onDelete: Cascade)

**Unique Constraints**:
- `[platformInvoiceId, orderId]` (@unique)

**Indexes**:
- `platformInvoiceId`
- `orderId`

---

### 27. `AdminUser`
**Tenancy Boundary**: None (platform-wide admin)

**Key Fields**:
- `id` (String, @id, cuid)
- `userId` (String, @unique) - Supabase/Clerk user ID
- `email` (String)
- `name` (String?)
- `isActive` (Boolean, default: true)
- `mustResetPassword` (Boolean, default: false)
- `createdAt`, `updatedAt` (DateTime)

**Relationships**:
- `roles` → `AdminUserRole[]` (one-to-many)

**Unique Constraints**:
- `userId` (@unique)

**Indexes**:
- `userId`
- `email`
- `isActive`

---

### 28. `Role`
**Tenancy Boundary**: None (platform-wide)

**Key Fields**:
- `id` (String, @id, cuid)
- `name` (String, @unique)
- `description` (String?)
- `isSystem` (Boolean, default: false) - Cannot be deleted
- `createdAt`, `updatedAt` (DateTime)

**Relationships**:
- `permissions` → `RolePermission[]` (one-to-many)
- `adminUsers` → `AdminUserRole[]` (one-to-many)

**Unique Constraints**:
- `name` (@unique)

**Indexes**:
- `name`

---

### 29. `Permission`
**Tenancy Boundary**: None (platform-wide)

**Key Fields**:
- `id` (String, @id, cuid)
- `key` (String, @unique) - e.g., "billing_profile.read"
- `label` (String) - Human-readable label

**Relationships**:
- `roles` → `RolePermission[]` (one-to-many)

**Unique Constraints**:
- `key` (@unique)

**Indexes**:
- `key`

---

### 30. `RolePermission`
**Tenancy Boundary**: None (platform-wide)

**Key Fields**:
- `id` (String, @id, cuid)
- `roleId` (String)
- `permissionId` (String)

**Relationships**:
- `role` → `Role` (many-to-one, onDelete: Cascade)
- `permission` → `Permission` (many-to-one, onDelete: Cascade)

**Unique Constraints**:
- `[roleId, permissionId]` (@unique)

**Indexes**:
- `roleId`
- `permissionId`

---

### 31. `AdminUserRole`
**Tenancy Boundary**: None (platform-wide)

**Key Fields**:
- `id` (String, @id, cuid)
- `adminUserId` (String)
- `roleId` (String)
- `createdAt` (DateTime)

**Relationships**:
- `adminUser` → `AdminUser` (many-to-one, onDelete: Cascade)
- `role` → `Role` (many-to-one, onDelete: Cascade)

**Unique Constraints**:
- `[adminUserId, roleId]` (@unique)

**Indexes**:
- `adminUserId`
- `roleId`

---

### 32. `SystemSettings`
**Tenancy Boundary**: None (singleton, platform-wide)

**Key Fields**:
- `id` (String, @id, default: "singleton")
- `maintenanceMode` (Boolean, default: false)
- `maintenanceBanner` (String?)
- `supportEmail`, `supportPhone` (String?)
- `enableCustomDomains` (Boolean, default: true)
- `enablePayouts` (Boolean, default: true)
- `enablePlatformInvoices` (Boolean, default: true)
- `updatedAt`, `createdAt` (DateTime)

---

### 33. `InvoiceSequence`
**Tenancy Boundary**: None (platform-wide invoice numbering)

**Key Fields**:
- `id` (String, @id, cuid)
- `financialYear` (String, @unique) - Format: "2025-26"
- `lastNumber` (Int, default: 0)
- `updatedAt`, `createdAt` (DateTime)

**Unique Constraints**:
- `financialYear` (@unique)

**Indexes**:
- `financialYear`

---

### 34. `InvoiceRecord`
**Tenancy Boundary**: `merchantId` (String)

**Key Fields**:
- `id` (String, @id, cuid)
- `merchantId` (String)
- `financialYear` (String)
- `invoiceNumber` (String, @unique)
- `periodFrom`, `periodTo` (DateTime)
- `generatedAt` (DateTime, default: now())
- `generatedBy` (InvoiceGeneratedBy)
- `hash` (String?) - Optional integrity hash

**Relationships**:
- `merchant` → `Merchant` (many-to-one, onDelete: Cascade)
- `ledgerEntries` → `LedgerEntry[]` (one-to-many)

**Unique Constraints**:
- `invoiceNumber` (@unique)

**Indexes**:
- `merchantId`
- `[merchantId, financialYear]`
- `invoiceNumber`
- `[periodFrom, periodTo]`

---

### 35. `OrderCounter`
**Tenancy Boundary**: None (platform-wide order numbering)

**Key Fields**:
- `id` (String, @id, cuid)
- `key` (String, @unique) - Format: "ORD-2602" (ORD-YYMM)
- `seq` (Int, default: 0)
- `updatedAt` (DateTime)

**Unique Constraints**:
- `key` (@unique)

---

## Tenancy Boundaries Summary

### Root Tenant Entity
- **`Merchant`** - No `merchantId` field (root entity)

### Direct Tenant Scoping (has `merchantId` field)
- `User` (nullable)
- `StorefrontSettings`
- `StorefrontPage`
- `Product`
- `Order`
- `Payment`
- `LedgerEntry`
- `PayoutBatch`
- `MerchantFeeConfig`
- `MerchantOnboarding`
- `MerchantBankAccount`
- `MerchantStoreSettings`
- `PlatformInvoice`
- `InvoiceRecord`

### Indirect Tenant Scoping (via foreign key chain)
- `ProductImage` → `Product.merchantId`
- `OrderItem` → `Order.merchantId`
- `Shipment` → `Order.merchantId`
- `Refund` → `Order.merchantId`
- `OrderEvent` → `Order.merchantId`
- `PlatformInvoiceLineItem` → `PlatformInvoice.merchantId`
- `PlatformInvoiceOrder` → `Order.merchantId`

### Platform-Wide (No Tenant Scoping)
- `PricingPackage`
- `AdminAuditLog`
- `PlatformSettings`
- `PlatformBillingProfile`
- `PlatformSettlementCycle`
- `AdminUser`
- `Role`
- `Permission`
- `RolePermission`
- `AdminUserRole`
- `SystemSettings`
- `InvoiceSequence`
- `OrderCounter`

---

## Relationship Summary

### One-to-One Relationships
- `Merchant` ↔ `StorefrontSettings` (via `merchantId` @unique)
- `Merchant` ↔ `MerchantFeeConfig` (via `merchantId` @unique)
- `Merchant` ↔ `MerchantBankAccount` (via `merchantId` @unique)
- `Merchant` ↔ `MerchantOnboarding` (via `merchantId` @unique)
- `Merchant` ↔ `MerchantStoreSettings` (via `merchantId` @unique)
- `Order` ↔ `Payment` (via `orderId` @unique)

### One-to-Many Relationships
- `Merchant` → `User[]`
- `Merchant` → `StorefrontPage[]`
- `Merchant` → `Product[]`
- `Merchant` → `Order[]`
- `Merchant` → `Payment[]`
- `Merchant` → `LedgerEntry[]`
- `Merchant` → `PayoutBatch[]`
- `Merchant` → `PlatformInvoice[]`
- `Merchant` → `InvoiceRecord[]`
- `Product` → `ProductImage[]`
- `Product` → `OrderItem[]`
- `Order` → `OrderItem[]`
- `Order` → `Shipment[]`
- `Order` → `Refund[]`
- `Order` → `OrderEvent[]`
- `Order` → `PlatformInvoiceOrder[]`
- `PayoutBatch` → `LedgerEntry[]`
- `PlatformSettlementCycle` → `PlatformInvoice[]`
- `PlatformInvoice` → `PlatformInvoiceLineItem[]`
- `PlatformInvoice` → `PayoutBatch[]`
- `PlatformInvoice` → `PlatformInvoiceOrder[]`
- `PricingPackage` → `MerchantFeeConfig[]`
- `AdminUser` → `AdminUserRole[]`
- `Role` → `RolePermission[]`
- `Role` → `AdminUserRole[]`
- `Permission` → `RolePermission[]`
- `InvoiceRecord` → `LedgerEntry[]`

### Many-to-Many Relationships
- `Order` ↔ `PlatformInvoice` (via `PlatformInvoiceOrder` join table)

---

## Unique Constraints Summary

### Single Field Uniques
- `Merchant.slug`
- `User.authUserId`
- `StorefrontSettings.merchantId`
- `MerchantFeeConfig.merchantId`
- `MerchantOnboarding.merchantId`
- `MerchantBankAccount.merchantId`
- `MerchantStoreSettings.merchantId`
- `Payment.orderId`
- `PlatformInvoice.invoiceNumber`
- `InvoiceRecord.invoiceNumber`
- `Role.name`
- `Permission.key`
- `AdminUser.userId`
- `InvoiceSequence.financialYear`
- `OrderCounter.key`
- `PlatformBillingProfile.id` (singleton: "platform")
- `PlatformSettings.id` (singleton: "singleton")
- `SystemSettings.id` (singleton: "singleton")

### Composite Uniques
- `StorefrontPage.[merchantId, slug]`
- `PlatformSettlementCycle.[periodStart, periodEnd]`
- `PlatformInvoiceOrder.[platformInvoiceId, orderId]`
- `RolePermission.[roleId, permissionId]`
- `AdminUserRole.[adminUserId, roleId]`

---

## Key Design Patterns

### 1. Multi-Tenancy
- All merchant-scoped data has `merchantId` field
- Cascade deletes ensure data isolation
- Indexes on `merchantId` for query performance

### 2. Soft Deletes
- `PricingPackage.deletedAt` - Soft delete for packages

### 3. Singleton Models
- `PlatformSettings` (id: "singleton")
- `SystemSettings` (id: "singleton")
- `PlatformBillingProfile` (id: "platform")

### 4. Audit Trail
- `AdminAuditLog` - Tracks all admin actions with before/after snapshots
- `OrderEvent` - Tracks order lifecycle events

### 5. Financial Year Sequencing
- `InvoiceSequence` - Tracks invoice numbers per financial year
- `InvoiceRecord` - Links invoices to financial years

### 6. Order Numbering
- `OrderCounter` - Tracks order numbers per month (ORD-YYMM format)

### 7. GST/Tax Support
- `LedgerEntry` - Stores detailed GST breakdown (CGST, SGST, IGST)
- `Product` - HSN/SAC codes and GST rates
- `Order` - Invoice type (TAX_INVOICE vs BILL_OF_SUPPLY)

### 8. Platform Settlement
- `PlatformSettlementCycle` - Weekly settlement cycles
- `PlatformInvoice` - Invoices from platform to merchants
- `PlatformInvoiceLineItem` - Line items for platform invoices

### 9. RBAC (Role-Based Access Control)
- `AdminUser` - Admin users
- `Role` - Roles
- `Permission` - Permissions
- `RolePermission` - Role-Permission mapping
- `AdminUserRole` - User-Role assignment
