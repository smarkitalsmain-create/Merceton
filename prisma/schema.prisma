// Multi-tenant Ecommerce SaaS Schema
// Every record is scoped to merchantId for data isolation

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================================================
// TENANT & USER MANAGEMENT
// ============================================================================

model Merchant {
  id          String   @id @default(cuid())
  slug        String   @unique
  displayName String
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Custom domain configuration
  // NOTE: do NOT keep @unique here for production-grade behavior.
  customDomain            String?
  domainStatus            DomainStatus @default(PENDING)
  domainVerificationToken String?
  domainVerifiedAt        DateTime?

  // Platform fee configuration
  feePercentageBps Int?
  feeFlatPaise     Int?
  feeMaxCapPaise   Int?

  // Relations
  users         User[]
  storefront    StorefrontSettings?
  pages         StorefrontPage[]
  products      Product[]
  orders        Order[]
  payments      Payment[]
  ledgerEntries LedgerEntry[]
  payoutBatches PayoutBatch[]
  feeConfig     MerchantFeeConfig?
  bankAccount   MerchantBankAccount?
  onboarding    MerchantOnboarding?

  @@index([slug])
  @@index([isActive])
  @@index([customDomain])
  @@index([customDomain, domainStatus])

  @@map("merchants")
}

model User {
  id         String   @id @default(cuid())
  merchantId String?
  authUserId String   @unique
  email      String
  name       String?
  role       UserRole @default(ADMIN)
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  merchant Merchant? @relation(fields: [merchantId], references: [id], onDelete: SetNull)

  @@index([merchantId])
  @@index([authUserId])
  @@map("users")
}

enum UserRole {
  ADMIN
  STAFF
}

enum DomainStatus {
  PENDING
  VERIFIED
  ACTIVE
}

// ============================================================================
// STOREFRONT
// ============================================================================

model StorefrontSettings {
  id         String   @id @default(cuid())
  merchantId String   @unique

  mode        StorefrontMode @default(THEME)

  // Theme-based storefront
  theme       String? @default("minimal")
  themeConfig Json?

  // Custom code storefront
  customHtml  String? @db.Text
  customCss   String? @db.Text
  customJs    String? @db.Text

  // Builder storefront (GrapesJS / future editor)
  builderJson Json?
  builderHtml String? @db.Text
  builderCss  String? @db.Text

  // Common
  logoUrl     String?
  publishedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  merchant Merchant @relation(fields: [merchantId], references: [id], onDelete: Cascade)

  @@map("storefront_settings")
}

enum StorefrontMode {
  THEME
  BUILDER
  CUSTOM_CODE
}

// ============================================================================
// STOREFRONT PAGES (SECTION-BASED BUILDER)
// ============================================================================

model StorefrontPage {
  id         String   @id @default(cuid())
  merchantId String
  slug       String   @default("home")
  title      String
  layoutJson Json
  isPublished Boolean  @default(true)
  publishedAt DateTime?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  merchant Merchant @relation(fields: [merchantId], references: [id], onDelete: Cascade)

  @@unique([merchantId, slug])
  @@index([merchantId])
  @@map("storefront_pages")
}

// ============================================================================
// CATALOG
// ============================================================================

model Product {
  id          String   @id @default(cuid())
  merchantId  String
  name        String
  description String?
  price       Int
  mrp         Int?
  sku         String?
  stock       Int      @default(0)
  isActive    Boolean  @default(true)
  
  // GST & HSN fields (required if merchant is GST registered)
  hsnOrSac    String?
  gstRate     Int?     // GST rate as percentage (0, 5, 12, 18, 28)
  isTaxable   Boolean  @default(true)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  merchant   Merchant       @relation(fields: [merchantId], references: [id], onDelete: Cascade)
  images     ProductImage[]
  orderItems OrderItem[]

  @@index([merchantId])
  @@index([merchantId, isActive])
  @@index([merchantId, createdAt])
  @@index([sku])
  @@map("products")
}

model ProductImage {
  id        String   @id @default(cuid())
  productId String
  url       String
  alt       String?
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([productId, sortOrder])
  @@map("product_images")
}

// ============================================================================
// ORDERS
// ============================================================================

model Order {
  id              String      @id @default(cuid())
  merchantId      String
  orderNumber     String
  customerName    String
  customerEmail   String
  customerPhone   String?
  customerAddress String

  /// Shipping and lifecycle
  shippingAddress  Json?
  stage            OrderStage      @default(NEW)
  status           OrderStatus     @default(PENDING)
  paymentStatus    PaymentStatus   @default(PENDING)
  settlementStatus SettlementStatus @default(NOT_ELIGIBLE)

  /// Amount breakdown (INR)
  subtotal    Decimal @db.Decimal(10, 2) @default(0)
  tax         Decimal @db.Decimal(10, 2) @default(0)
  shippingFee Decimal @db.Decimal(10, 2) @default(0)
  discount    Decimal @db.Decimal(10, 2) @default(0)
  totalAmount Decimal @db.Decimal(10, 2) @default(0)

  /// Legacy/platform fee fields (used by existing flows)
  grossAmount Decimal @db.Decimal(10, 2)
  platformFee Decimal @db.Decimal(10, 2)
  netPayable  Decimal @db.Decimal(10, 2)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  merchant      Merchant      @relation(fields: [merchantId], references: [id], onDelete: Cascade)
  items         OrderItem[]
  payment       Payment?
  ledgerEntries LedgerEntry[]
  shipments     Shipment[]
  refunds       Refund[]
  events        OrderEvent[]

  @@unique([merchantId, orderNumber])
  @@index([merchantId])
  @@index([merchantId, status])
  @@index([merchantId, stage])
  @@index([merchantId, createdAt])
  @@index([orderNumber])
  @@map("orders")
}

enum OrderStatus {
  PENDING
  PLACED
  CONFIRMED
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
}

enum OrderStage {
  NEW
  CONFIRMED
  PACKED
  SHIPPED
  OUT_FOR_DELIVERY
  DELIVERED
  CANCELLED
  RETURNED
}

// Order items

model OrderItem {
  id        String   @id @default(cuid())
  orderId   String
  productId String
  productName String?
  sku         String?
  imageUrl    String?
  quantity    Int
  price       Int
  createdAt DateTime @default(now())

  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id])

  @@index([orderId])
  @@index([productId])
  @@map("order_items")
}

model Shipment {
  id          String   @id @default(cuid())
  orderId     String
  courierName String
  awb         String
  trackingUrl String?
  shippedAt   DateTime?
  deliveredAt DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@map("shipments")
}

model Refund {
  id        String        @id @default(cuid())
  orderId   String
  amount    Decimal       @db.Decimal(10, 2)
  reason    String
  status    RefundStatus  @default(PENDING)
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@map("refunds")
}

model OrderEvent {
  id        String         @id @default(cuid())
  orderId   String
  type      OrderEventType
  message   String
  oldValue  Json?
  newValue  Json?
  createdBy String
  createdAt DateTime       @default(now())

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([createdAt])
  @@map("order_events")
}

enum RefundStatus {
  PENDING
  COMPLETED
  FAILED
}

enum OrderEventType {
  STAGE_CHANGE
  PAYMENT_UPDATE
  NOTE
  SYSTEM
}

// ============================================================================
// PAYMENTS
// ============================================================================

model Payment {
  id            String        @id @default(cuid())
  merchantId    String
  orderId       String        @unique
  paymentMethod PaymentMethod
  status        PaymentStatus @default(PENDING)

  razorpayOrderId   String?
  razorpayPaymentId String?
  razorpaySignature String?

  upiTransactionId String?

  codCollected   Boolean   @default(false)
  codCollectedAt DateTime?

  amount    Decimal  @db.Decimal(10, 2)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  merchant Merchant @relation(fields: [merchantId], references: [id], onDelete: Cascade)
  order    Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([merchantId])
  @@index([merchantId, status])
  @@index([orderId])
  @@index([razorpayOrderId])
  @@index([razorpayPaymentId])
  @@index([merchantId, createdAt])
  @@map("payments")
}

enum PaymentMethod {
  RAZORPAY
  COD
  UPI
}

enum PaymentStatus {
  CREATED
  PENDING
  PAID
  FAILED
  REFUNDED
  PARTIALLY_REFUNDED
}

enum SettlementStatus {
  NOT_ELIGIBLE
  ELIGIBLE
  ON_HOLD
  SETTLED
}

// ============================================================================
// LEDGER & PAYOUTS
// ============================================================================

model LedgerEntry {
  id            String       @id @default(cuid())
  merchantId    String
  orderId       String
  type          LedgerType
  amount        Decimal      @db.Decimal(10, 2)
  description   String?
  status        LedgerStatus @default(PENDING)
  payoutBatchId String?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  merchant    Merchant     @relation(fields: [merchantId], references: [id], onDelete: Cascade)
  order       Order        @relation(fields: [orderId], references: [id], onDelete: Cascade)
  payoutBatch PayoutBatch? @relation(fields: [payoutBatchId], references: [id], onDelete: SetNull)

  @@index([merchantId])
  @@index([merchantId, type])
  @@index([merchantId, status])
  @@index([orderId])
  @@index([payoutBatchId])
  @@index([merchantId, createdAt])
  @@map("ledger_entries")
}

enum LedgerType {
  GROSS_ORDER_VALUE
  PLATFORM_FEE
  ORDER_PAYOUT
  PAYOUT_PROCESSED
}

enum LedgerStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

model PayoutBatch {
  id              String       @id @default(cuid())
  merchantId       String
  totalAmount      Decimal      @db.Decimal(10, 2)
  status           PayoutStatus @default(PENDING)
  razorpayPayoutId String?
  processedAt      DateTime?
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt

  merchant      Merchant      @relation(fields: [merchantId], references: [id], onDelete: Cascade)
  ledgerEntries LedgerEntry[]

  @@index([merchantId])
  @@index([merchantId, status])
  @@index([merchantId, createdAt])
  @@index([razorpayPayoutId])
  @@map("payout_batches")
}

enum PayoutStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

// ============================================================================
// PRICING PACKAGES
// ============================================================================

model PricingPackage {
  id               String                @id @default(cuid())
  name             String
  description      String?
  status           PricingPackageStatus  @default(DRAFT) // DRAFT, PUBLISHED, ARCHIVED
  fixedFeePaise    Int                   // per successful order fixed fee
  variableFeeBps   Int                   // per successful order % fee in bps
  domainPricePaise Int                   @default(9900) // ₹99 default
  domainAllowed    Boolean               @default(true) // merchant can buy domain add-on
  domainIncluded   Boolean               @default(false) // if true, domain is included in plan
  payoutFrequency  PayoutFrequency       @default(WEEKLY)
  holdbackBps      Int                   @default(0)
  isPayoutHold     Boolean               @default(false)
  isActive         Boolean               @default(true)
  visibility       PackageVisibility     @default(PUBLIC)
  deletedAt        DateTime?             // soft delete
  createdAt        DateTime              @default(now())
  updatedAt        DateTime              @updatedAt

  merchantFeeConfigs MerchantFeeConfig[]
  auditLogs         AdminAuditLog[]
  platformSettings  PlatformSettings[]

  @@index([status])
  @@index([isActive])
  @@index([visibility])
  @@index([deletedAt])
  @@map("pricing_packages")
}

enum PricingPackageStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum PayoutFrequency {
  WEEKLY
  DAILY
  MANUAL
}

enum PackageVisibility {
  PUBLIC
  INTERNAL
}

// ============================================================================
// MERCHANT FEE CONFIGURATION
// ============================================================================

model MerchantFeeConfig {
  id                        String   @id @default(cuid())
  merchantId                String   @unique
  pricingPackageId          String?
  
  // Admin-only overrides
  fixedFeeOverridePaise     Int?
  variableFeeOverrideBps    Int?
  payoutFrequencyOverride   PayoutFrequency?
  holdbackOverrideBps       Int?
  isPayoutHoldOverride      Boolean?
  
  // Domain subscription
  domainSubscriptionActive     Boolean @default(false)
  domainIncludedApplied        Boolean? // record if domainIncluded was applied
  
  createdAt                  DateTime @default(now())
  updatedAt                  DateTime @updatedAt

  merchant      Merchant       @relation(fields: [merchantId], references: [id], onDelete: Cascade)
  pricingPackage PricingPackage? @relation(fields: [pricingPackageId], references: [id], onDelete: SetNull)

  @@index([merchantId])
  @@index([pricingPackageId])
  @@map("merchant_fee_configs")
}

// ============================================================================
// ADMIN AUDIT LOG
// ============================================================================

model AdminAuditLog {
  id          String   @id @default(cuid())
  actorUserId String   // Clerk userId (renamed from adminUserId)
  actorEmail  String?  // Optional email
  actionType  String   // AuditAction enum value or custom string
  entityType  String   // "PricingPackage", "MerchantFeeConfig", "Merchant", etc.
  entityId    String?
  reason      String   // mandatory reason
  beforeJson  Json?    // snapshot before change
  afterJson   Json?     // snapshot after change
  ip          String?  // Optional IP address
  userAgent   String?  // Optional user agent
  metadata    Json?    // Optional metadata for debugging/context
  createdAt   DateTime @default(now())

  pricingPackage PricingPackage? @relation(fields: [pricingPackageId], references: [id], onDelete: SetNull)
  pricingPackageId String?

  @@index([actorUserId])
  @@index([actionType])
  @@index([entityType, entityId])
  @@index([createdAt])
  @@map("admin_audit_logs")
}

enum AuditAction {
  PRICING_PACKAGE_CREATE
  PRICING_PACKAGE_UPDATE
  PRICING_PACKAGE_PUBLISH
  PRICING_PACKAGE_ARCHIVE
  PRICING_PACKAGE_TOGGLE_ACTIVE
  PRICING_PACKAGE_DELETE
  MERCHANT_PACKAGE_ASSIGN
  MERCHANT_PACKAGE_UPDATE_OVERRIDES
  MERCHANT_DOMAIN_SUBSCRIPTION_TOGGLE
  MERCHANT_ACTIVATE
  MERCHANT_DEACTIVATE
  MERCHANT_HOLDBACK_SET
  MERCHANT_PAYOUT_HOLD_SET
  PLATFORM_SETTINGS_UPDATE
}

// ============================================================================
// PLATFORM SETTINGS (SINGLETON)
// ============================================================================

model PlatformSettings {
  id                      String   @id @default("singleton")
  defaultFeePercentageBps Int?     @default(200) // 2% default (legacy)
  defaultFeeFlatPaise     Int?     @default(500) // ₹5 default (legacy)
  defaultFeeMaxCapPaise   Int?     @default(2500) // ₹25 default (legacy)
  defaultPricingPackageId String?  // default package for new merchants
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  defaultPricingPackage PricingPackage? @relation(fields: [defaultPricingPackageId], references: [id], onDelete: SetNull)

  @@map("platform_settings")
}

// ============================================================================
// MERCHANT ONBOARDING
// ============================================================================

model MerchantOnboarding {
  id          String              @id @default(cuid())
  merchantId  String              @unique
  
  // Onboarding status
  onboardingStatus OnboardingStatus @default(NOT_STARTED)
  completedAt      DateTime?
  profileCompletionPercent Int?   @default(0) // 0-100
  
  // PAN Details (Layer 1 - Compliance)
  panType         String?  // "INDIVIDUAL" | "COMPANY" | "HUF" | "PARTNERSHIP" | "LLP" | "AOP" | "BOI"
  panNumber       String?  // 10 alphanumeric characters
  panName         String?  // Name as per PAN
  panDobOrIncorp  DateTime? // Date of birth (individual) or Incorporation date (company)
  panHolderRole   String?  // "PROPRIETOR" | "DIRECTOR" | "PARTNER" | etc.
  
  // GST Details (Layer 1 - Compliance)
  gstStatus              GstStatus @default(NOT_REGISTERED)
  gstin                  String?   // 15 alphanumeric characters (if REGISTERED)
  gstLegalName           String?   // Legal name as per GST certificate
  gstTradeName           String?   // Trade name (if different)
  gstState               String?   // State code (2 digits) or state name
  gstComposition         Boolean   @default(false) // Composition scheme
  gstNotRegisteredReason String?   // Reason if NOT_REGISTERED
  
  // Business Basics (Layer 2)
  storeDisplayName   String?  // Display name for store (can differ from legal name)
  legalBusinessName  String?  // Legal business name
  yearStarted        Int?     // Year business started
  businessType       String?  // "SOLE_PROPRIETORSHIP" | "PARTNERSHIP" | "LLP" | "PVT_LTD" | "PUBLIC_LTD" | "HUF" | "OTHER"
  primaryCategory    String?  // Primary product category
  secondaryCategory  String?  // Secondary category (optional)
  avgPriceRange      String?  // "UNDER_500" | "500_1000" | "1000_5000" | "5000_10000" | "ABOVE_10000"
  expectedSkuRange   String?  // "UNDER_10" | "10_50" | "50_100" | "100_500" | "ABOVE_500"
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  merchant Merchant @relation(fields: [merchantId], references: [id], onDelete: Cascade)

  @@index([merchantId])
  @@index([onboardingStatus])
  @@map("merchant_onboarding")
}

enum OnboardingStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
}

enum GstStatus {
  REGISTERED
  APPLIED
  NOT_REGISTERED
}

// ============================================================================
// MERCHANT BANK ACCOUNT
// ============================================================================

model MerchantBankAccount {
  id                 String                 @id @default(cuid())
  merchantId         String                 @unique
  accountHolderName  String
  bankName           String
  accountNumber      String
  ifscCode           String
  accountType        BankAccountType        @default(SAVINGS)
  isPrimary          Boolean                @default(true)
  verificationStatus BankVerificationStatus @default(NOT_SUBMITTED)
  proofType          BankProofType?
  proofDocumentUrl   String?
  proofUploadedAt    DateTime?
  submittedAt        DateTime?
  verifiedAt         DateTime?
  rejectedAt         DateTime?
  rejectionReason    String?
  createdAt          DateTime               @default(now())
  updatedAt          DateTime               @updatedAt

  merchant Merchant @relation(fields: [merchantId], references: [id], onDelete: Cascade)

  @@index([merchantId])
  @@index([verificationStatus])
  @@map("merchant_bank_accounts")
}

enum BankAccountType {
  SAVINGS
  CURRENT
}

enum BankVerificationStatus {
  NOT_SUBMITTED
  PENDING
  VERIFIED
  REJECTED
}

enum BankProofType {
  CANCELLED_CHEQUE
  BANK_STATEMENT
}
